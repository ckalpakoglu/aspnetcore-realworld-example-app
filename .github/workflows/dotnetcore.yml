name: Build and Generate SBOM

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0'

      - name: Install dependencies
        run: dotnet restore

      - name: Build the project
        run: dotnet build --configuration Release

      - name: Publish the project
        run: dotnet publish --configuration Release --output ./build/bin/Release/net6.0

      - name: Install CycloneDX CLI
        run: |
          VERSION=0.27.1
          DOWNLOAD_URL="https://github.com/CycloneDX/cyclonedx-cli/releases/download/v$VERSION/cyclonedx-cli-$VERSION-linux-x64.tar.gz"
          curl -sL "$DOWNLOAD_URL" -o cyclonedx.tar.gz
          tar -xzf cyclonedx.tar.gz
          sudo mv cyclonedx-cli-$VERSION/cyclonedx /usr/local/bin/cyclonedx

      - name: Generate SBOM with CycloneDX
        run: |
          if [ ! -f "./build/bin/Release/net6.0/myapp.dll" ]; then
            echo "Error: myapp.dll not found in build/bin/Release/net6.0/"
            exit 1
          fi
          cyclonedx convert --input-file ./build/bin/Release/net6.0/myapp.dll --output-file sbom.xml --input-format auto --output-format xml
